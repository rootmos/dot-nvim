name: Tests
on:
  push:
  workflow_dispatch:
  schedule:
    - cron: "43 3 * * *"

jobs:
  tests:
    strategy:
      fail-fast: false
      matrix:
        distro: [ "archlinux", "debian", "ubuntu" ]
    runs-on: ubuntu-latest
    container:
      image: ${{ matrix.distro }}:latest
    env:
      ARTIFACT_ROOT: /tmp/tests
    steps:
    # https://stackoverflow.com/a/60942437
    - name: Get current date
      id: date
      run: echo "date=$(date +'%Y-%m-%d')" >> "$GITHUB_OUTPUT"

    - name: Check out preparation files
      uses: actions/checkout@v6
      with:
        sparse-checkout: .github/prepare
        sparse-checkout-cone-mode: false

    - name: Prepare build environment
      run: .github/prepare -u


    - name: Check out repository code
      uses: actions/checkout@v6

    - name: Extract current Neovim version
      id: neovim
      run: echo "version=$(cat version)" >> "$GITHUB_OUTPUT"


    - name: Restore cached Neovim build
      id: cache-neovim
      uses: actions/cache/restore@v4
      with:
        path: root/${{ steps.neovim.outputs.version }}
        key: ${{ matrix.distro }}_${{ steps.date.outputs.date }}_${{ steps.neovim.outputs.version }}

    - name: Install build dependencies
      if: steps.cache-neovim.outputs.cache-hit != 'true'
      run: .github/deps -b

    - name: Build
      if: steps.cache-neovim.outputs.cache-hit != 'true'
      run: make build

    - name: Remove build dependencies
      if: steps.cache-neovim.outputs.cache-hit != 'true'
      run: .github/deps -b -R

    - name: Save Neovim build
      if: steps.cache-neovim.outputs.cache-hit != 'true'
      uses: actions/cache/save@v4
      with:
        path: root/${{ steps.neovim.outputs.version }}
        key: ${{ steps.cache-neovim.outputs.cache-primary-key }}


    - name: Install runtime dependencies
      run: .github/deps -r

    - name: ${{ github.event_name == 'schedule' && 'Update' || 'Install' }} plugins
      run: ./plugins ${{ github.event_name == 'schedule' && 'update' || 'install' }}

    - name: Keep changes
      if: (success() || failure()) && matrix.distro != 'ubuntu' # TODO why doesn't actions/checkout + git diff work on ubuntu?
      run: |
        mkdir -p "${{ env.ARTIFACT_ROOT }}/${{ env.ARTIFACT }}"
        git config --global --add safe.directory .
        git diff --output="${{ env.ARTIFACT_ROOT }}/${{ env.ARTIFACT }}/${{ github.job }}.patch"
        cat "${{ env.ARTIFACT_ROOT }}/${{ env.ARTIFACT }}/${{ github.job }}.patch"
      env:
        ARTIFACT: &artifact "${{ github.job }}_${{ matrix.distro }}_${{ steps.date.outputs.date }}_${{ steps.neovim.outputs.version }}_${{ github.run_id }}"

    - name: Install test dependencies
      run: .github/deps -t

    - name: Run tests
      run: make tests DOT_NVIM_TESTS_WORKDIR="${{ env.ARTIFACT_ROOT }}/${{ env.ARTIFACT }}"
      env:
        ARTIFACT: *artifact

    - name: Keep artifacts
      if: success() || failure()
      uses: actions/upload-artifact@v4
      with:
        name: *artifact
        path: "${{ env.ARTIFACT_ROOT }}"
